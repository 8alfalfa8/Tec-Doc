# ◆ エンタープライズRAG設計書

以下に、**エンタープライズRAG設計書**（**テンプレート＋記載例**）を提示します。
金融・公共でも通用する**監査／セキュリティ／可用性**観点を含みます。

---

## 1. 目的・スコープ

### 1.1 目的

社内文書・規程・FAQ等を横断検索し、LLMで回答生成する**RAG（Retrieval-Augmented Generation）基盤**を構築する。

### 1.2 対象範囲

* 社内ポータル（Web）
* 文書管理（PDF/Office/Confluence等）
* API連携（将来拡張）

---

## 2. 全体アーキテクチャ

### 2.1 論理構成

```
[User]
   │
[Web/BFF]
   │
[Auth / RBAC]
   │
[Query API]
   ├─→ Retrieval Service
   │      ├─ Vector DB
   │      └─ Metadata DB (RDB)
   │
   └─→ LLM Service
            └─ External LLM API
```

#### 主要コンポーネント

* LLM：OpenAI（API利用想定）
* ベクトルDB：Weaviate（例）
* クラウド基盤：Amazon Web Services

---

## 3. 機能要件

### 3.1 検索機能

* キーワード＋ベクトル検索（ハイブリッド）
* 上位K件取得
* メタデータフィルタ（部門・機密区分）

### 3.2 生成機能

* コンテキスト注入型プロンプト
* 出典明示
* 信頼度表示（オプション）

### 3.3 管理機能

* 文書登録／更新
* Embedding再生成
* ログ閲覧
* 権限管理

---

## 4. 非機能要件

### 4.1 可用性

* SLA 99.9%以上
* マルチAZ構成
* フェイルオーバー設計

### 4.2 性能

* 応答時間：3秒以内（P95）
* 同時接続：想定500ユーザ

### 4.3 拡張性

* 文書10万件対応
* 水平スケール可能

### 4.4 セキュリティ

* SSO連携
* RBAC
* 通信暗号化（TLS）
* 保存時暗号化

---

## 5. データ設計

### 5.1 RDB（メタデータ）

| カラム            | 内容    |
| -------------- | ----- |
| document_id    | 文書ID  |
| title          | タイトル  |
| department     | 所属    |
| classification | 機密区分  |
| version        | バージョン |
| created_at     | 登録日   |

---

### 5.2 ベクトルDB設計

| フィールド       | 内容         |
| ----------- | ---------- |
| vector      | embedding値 |
| text_chunk  | 分割テキスト     |
| document_id | 紐付け        |
| metadata    | JSON       |

---

### 5.3 チャンク設計

* 500〜1000トークン
* オーバーラップ 10〜20%
* セクション単位優先

---

## 6. RAG処理フロー

### 6.1 登録フロー

1. 文書取得
2. 前処理（ノイズ除去）
3. チャンク分割
4. Embedding生成
5. Vector DB登録
6. メタ情報登録

---

### 6.2 問い合わせフロー

1. ユーザ質問受信
2. 質問Embedding生成
3. Top-K検索
4. メタデータフィルタ
5. コンテキスト整形
6. LLM生成
7. 出典付与
8. ログ保存

---

## 7. プロンプト設計方針

### 7.1 基本テンプレ

```
あなたは社内アシスタントです。
以下のコンテキストのみを根拠として回答してください。
不明な場合は「該当情報なし」と回答してください。

[Context]
{retrieved_text}

[Question]
{user_query}
```

---

### 7.2 対策

* 出典番号付与
* ハルシネーション抑止文
* 機密情報制限文

---

## 8. セキュリティ設計

### 8.1 プロンプトインジェクション対策

* システムプロンプト固定
* 外部URL無効化
* 入力検証

### 8.2 データ漏洩対策

* 部門フィルタリング
* 機密区分制御
* APIキー保管（Secrets Manager）

### 8.3 ログ監査

* 誰が何を検索したか
* 回答内容保存
* 改ざん防止

---

## 9. コスト設計

### 9.1 トークン管理

* 入力上限制御
* キャッシュ導入
* 頻出質問保存

### 9.2 月額試算項目

* LLM API利用料
* ベクトルDB運用費
* ストレージ費
* ログ保存費

---

## 10. 監視設計

### 10.1 監視対象

* API応答時間
* LLMエラー率
* 検索ヒット率
* トークン消費量

### 10.2 アラート

* SLA逸脱
* API上限超過
* 異常大量アクセス

---

## 11. テスト計画

### 11.1 機能テスト

* 正常系／異常系
* 権限制御

### 11.2 精度評価

* Top-Kヒット率
* 回答妥当性評価（人手レビュー）

### 11.3 セキュリティテスト

* インジェクション試験
* 情報漏洩確認

---

## 12. 運用設計

### 12.1 文書更新

* 差分検出
* 再Embedding

### 12.2 モデル更新

* バージョン管理
* A/Bテスト

### 12.3 ログ保存期間

* 1年（監査要件次第）

---

## 13. リスク一覧

| リスク      | 対策      |
| -------- | ------- |
| ハルシネーション | 出典明示    |
| 情報漏洩     | RBAC    |
| コスト暴騰    | トークン制御  |
| 精度低下     | チャンク最適化 |

---

## 14. 将来拡張

* マルチモーダル対応
* エージェント化
* 社内システム自動操作連携
* ナレッジグラフ統合

---

## ■ エンタープライズ設計で最重要

1. 「精度」より「安全性」優先
2. ログと監査を必ず設計
3. 出典を常に表示
4. LLMを信用しすぎない

---

