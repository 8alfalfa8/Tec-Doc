# ◆ エンタープライズRAG向け 本番ログからの継続評価設計

以下に、**エンタープライズRAG向け「本番ログからの継続評価設計」詳細版**を提示します。
目的は「本番利用データを用いた精度・安全性の継続的可視化と自動改善」です。

---

## 1. 全体コンセプト

```
本番ログ収集
   ↓
匿名化・権限検証
   ↓
評価データ自動生成
   ↓
自動スコアリング
   ↓
ダッシュボード可視化
   ↓
改善ループ（Retrieval/Prompt/Chunk）
```

---

## 2. ログ収集設計

### 2.1 必須ログ項目

| 項目                | 内容     |
| ----------------- | ------ |
| request_id        | 一意ID   |
| user_role         | 権限区分   |
| question          | 入力     |
| retrieved_doc_ids | 検索結果   |
| retrieved_scores  | 類似度    |
| generated_answer  | 生成結果   |
| prompt_version    | プロンプト版 |
| model_version     | モデル版   |
| latency           | 応答時間   |
| token_usage       | トークン消費 |

---

### 2.2 監査対応要件

* 改ざん防止（WORMストレージ）
* 1年以上保存
* モデル変更履歴紐付け

ログ基盤例：

* Amazon Web Services（S3＋CloudWatch）
* Datadog

---

## 3. ログから評価データ生成

### 3.1 良質データ抽出

抽出条件例：

```
・高評価フィードバックあり
・長時間閲覧
・再検索なし
```

→ 擬似ゴールドデータ化

---

### 3.2 失敗ケース抽出

検出ロジック：

* 連続再質問
* フィードバック低評価
* 取得文書と回答乖離
* 「違う」「誤り」など含有

---

## 4. 継続評価指標

### 4.1 本番Recall推定

厳密なRecallは困難なため：

```
Proxy Recall =
「ユーザが再検索しなかった率」
```

---

### 4.2 Faithfulness自動評価

LLM自己評価（夜間バッチ）

例：

* OpenAI API利用

---

### 4.3 ドリフト検出

#### ① Retrievalドリフト

* 平均類似度低下
* Top1スコア下落

#### ② 質問分布ドリフト

* Embedding分布変化
* 新カテゴリ急増

---

## 5. セキュリティ継続監視

### 5.1 権限逸脱監視

```
機密区分 > user_role の文書が
retrieved_doc_idsに含まれていないか
```

---

### 5.2 攻撃兆候検出

検知ワード例：

* 「ignore instructions」
* 「機密を表示」
* 「管理者権限」

発生率を時系列監視。

---

## 6. スコアリング自動パイプライン

```
Nightly Job
   ↓
ログ抽出
   ↓
評価スクリプト実行
   ↓
指標更新
   ↓
閾値判定
   ↓
Slack通知
```

---

## 7. ダッシュボード設計

### 7.1 必須KPI

| KPI            | 目標   |
| -------------- | ---- |
| 平均Faithfulness | >0.9 |
| 低評価率           | <5%  |
| 再検索率           | <20% |
| 権限逸脱件数         | 0    |
| P95応答時間        | <3秒  |

---

### 7.2 可視化例

* モデル別比較
* プロンプト別比較
* チャンクサイズ別
* 部門別精度

MLOps基盤：

* Weights & Biases

---

## 8. 改善ループ設計

### 8.1 自動改善候補生成

例：

* Recall低下 → K値調整
* Faithfulness低下 → プロンプト強化
* ノイズ増加 → Chunk再設計

---

### 8.2 A/Bテスト自動化

本番トラフィックの10%で新設定試験。

比較指標：

```
ΔFaithfulness
Δ再検索率
Δユーザ満足度
```

---

## 9. リスク管理

| リスク       | 対策         |
| --------- | ---------- |
| 本番データ偏り   | ランダムサンプリング |
| 個人情報混入    | 自動マスキング    |
| 評価LLMの誤判定 | 二重評価       |
| 評価コスト増大   | 夜間バッチ      |

---

## 10. 成熟度モデル

| Lv | 状態      |
| -- | ------- |
| 1  | ログ保存のみ  |
| 2  | 月次手動分析  |
| 3  | 自動スコア算出 |
| 4  | ドリフト検知  |
| 5  | 自動改善ループ |

エンタープライズ目標：Lv4以上

---

## 11. 実務で最重要ポイント

1. 本番ログが最大の教師データ
2. 再検索率は最強のProxy指標
3. セキュリティ指標を必ず並列監視
4. 評価をCIに組み込む

---
