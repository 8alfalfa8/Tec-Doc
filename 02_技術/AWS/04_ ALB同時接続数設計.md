# ◆ ALB 同時接続数設計

以下では **ALB（Application Load Balancer）の同時接続数設計**について、
**オンプレミス Tomcat システムを ECS に移行する前提**で、

* ① 設計の全体像
* ② オンプレ値からの算出方法
* ③ ALB／ECS／Tomcat それぞれの制限
* ④ 実務での設計パターン
* ⑤ 失敗しやすいポイント

を **設計判断ができるレベル**まで掘り下げて説明します。

---

## 1. ALB 同時接続数設計の全体像

#### 同時接続数は「ALB単体」では決まらない

```
[ Client ]
   ↓ 同時接続数
[ ALB ]
   ↓ 分散
[ ECS Service ]
   ↓
[ Tomcat (Task × N) ]
```

**設計対象は4点セット**

1. クライアント同時接続数
2. ALB の処理能力
3. ECS Task 数
4. Tomcat の maxThreads / コネクション処理能力

---

## 2. オンプレミスからの入力情報（必須）

#### 2.1 入手すべきオンプレ実測値

| 分類                | 具体例       | 取得方法       |
| ----------------- | --------- | ---------- |
| 同時接続数             | 最大800     | access log |
| リクエスト率            | 200 rps   | APM        |
| 応答時間              | P95=400ms | APM        |
| Tomcat maxThreads | 200       | server.xml |
| KeepAlive         | 有効        | 設定確認       |
| LB有無              | Apache    | 構成図        |

---

## 3. 同時接続数の基本計算（最重要）

### 3.1 Littleの法則（実務必須）

```
同時接続数 = RPS × 平均応答時間（秒）
```

#### 例（オンプレ）

```
RPS = 200
応答時間 = 0.4秒

→ 同時接続数 = 200 × 0.4 = 80
```

※ Keep-Alive 有効時は **×2〜5倍** を想定

```
80 × 3 = 240 接続
```

➡ **設計同時接続数 = 約250**

---

## 4. ALB の同時接続処理能力

### 4.1 ALB の基本特性（重要）

| 項目     | 内容        |
| ------ | --------- |
| スケール   | フルマネージド自動 |
| 同時接続   | 明示的な上限なし  |
| ボトルネック | Target 側  |

👉 **ALB自体がボトルネックになることは稀**

---

### 4.2 ただし存在する ALB 制限

| 項目           | 制限        |
| ------------ | --------- |
| 新規接続レート      | 約25,000/秒 |
| 同時接続数        | 数百万レベル    |
| HTTP/2       | 有効        |
| Idle Timeout | 1〜4000秒   |

👉 **実務では ECS/Tomcat が先に詰まる**

---

## 5. ECS Task 側への接続分散設計

### 5.1 Task 1台あたりの許容同時接続

#### Tomcat Thread基準

* 1 vCPU あたり **50〜100 threads**

#### 例

| 項目         | 値      |
| ---------- | ------ |
| Task CPU   | 2 vCPU |
| maxThreads | 200    |
| 実効利用       | 70%    |

```
200 × 0.7 = 140 同時処理
```

---

### 5.2 Task数の算出

#### 設計同時接続数

```
250 接続
```

#### Task 1台あたり

```
140 接続
```

#### 必要 Task数

```
250 ÷ 140 ≒ 1.8
```

➡ **最低 2 Task（冗長性含め 3 Task 推奨）**

---

## 6. ALB → ECS の接続モデル理解（重要）

### 6.1 接続の実態

* ALB は **クライアント接続を終端**
* ALB → ECS は **別TCP接続**

👉 クライアント接続数 ≠ Task接続数（1:1ではない）

---

### 6.2 Keep-Alive の影響

| 設定             | 影響    |
| -------------- | ----- |
| Keep-Alive 有効  | 接続数増  |
| Idle Timeout 長 | 接続滞留  |
| HTTP/2         | 接続効率↑ |

#### 推奨

* HTTP/2 有効
* Idle Timeout：60〜120秒

---

## 7. ALB Idle Timeout 設計

### 7.1 設計指針

| アプリ特性 | 推奨      |
| ----- | ------- |
| API   | 60秒     |
| Web   | 60–120秒 |
| 長処理   | アプリ非同期化 |

#### 設定例

```
Idle Timeout = 60s
```

---

### 7.2 失敗例

* Idle Timeout = 4000秒
* → 接続が溜まり続ける
* → Tomcat thread 枯渇

---

## 8. Auto Scaling を考慮した同時接続設計

### 8.1 スケール指標

| 指標                        | 目安       |
| ------------------------- | -------- |
| CPU                       | 60–70%   |
| Memory                    | 70%      |
| ALB RequestCountPerTarget | 500〜1000 |

---

### 8.2 設計例

| 項目      | 値  |
| ------- | -- |
| Min     | 2  |
| Desired | 3  |
| Max     | 10 |

👉 同時接続増加 → Task増加 → 接続分散

---

## 9. AWS 側の関連制限まとめ

### 9.1 ALB

| 項目       | 制限   |
| -------- | ---- |
| Target数  | 1000 |
| Rule数    | 100  |
| Listener | 50   |

---

### 9.2 ECS / ENI

| 項目             | 制限      |
| -------------- | ------- |
| Task ENI       | Taskごと1 |
| 同時接続           | OS制限に依存 |
| Ephemeral Port | 約28,000 |

👉 **大量短命接続ではポート枯渇注意**

---

## 10. 実務向け設計テンプレ（まとめ）

#### 設計手順（再現性あり）

1. **RPS × 応答時間 → 同時接続数**
2. Keep-Alive補正（×2〜5）
3. Tomcat maxThreads 確認
4. Task 1台あたり許容接続算出
5. Task数決定（冗長性含む）
6. Auto Scaling 設定
7. Idle Timeout 最適化

---

## 11. よくある設計ミス

❌ ALBの同時接続上限だけ見る
❌ Tomcat maxThreads 未変更
❌ Task数=オンプレ台数
❌ Idle Timeout 放置
❌ HTTP/1.1 固定

---

