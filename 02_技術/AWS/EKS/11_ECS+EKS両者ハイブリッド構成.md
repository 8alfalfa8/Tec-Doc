# ◆ ECS+EKS両者ハイブリッド構成

以下では、**Tomcat（WAR）資産を前提**に
**ECS（Fargate）＋ EKS（Kubernetes）を併用するハイブリッド構成**を、
**実務設計・金融／公共監査対応レベル**で体系的に解説します。

> 🎯 ゴール
>
> * 「なぜ混在させるのか」
> * 「どこで分けるのか」
> * 「どう安全に運用するのか」
>   を **設計判断として説明可能**にする

---

## 1. なぜ ECS + EKS ハイブリッドなのか

### 1.1 背景（よくある現実）

| 課題         | 解決      |
| ---------- | ------- |
| レガシーWARが多い | ECSで即移行 |
| 新規APIはモダン  | EKSで拡張  |
| 人材が限定的     | ECSで省運用 |
| 将来K8s標準化   | EKSで布石  |

👉 **「全部EKS」は理想だが現実的でない**

---

## 2. ハイブリッド全体アーキテクチャ

```
                    +------------------+
Internet → WAF → ALB|                  |
                    |  Routing Layer   |
                    |                  |
                    +--------+---------+
                             |
            +----------------+----------------+
            |                                 |
        ECS (Fargate)                     EKS Cluster
        Tomcat WAR                        Microservices
            |                                 |
        RDS / S3                         RDS / S3
```

---

## 3. 責務分離設計（最重要）

### 3.1 役割分担

| 領域    | ECS   | EKS   |
| ----- | ----- | ----- |
| WAR移行 | ◎     | △     |
| 新規API | ×     | ◎     |
| 複雑制御  | ×     | ◎     |
| 運用負荷  | **低** | 高     |
| 拡張性   | 中     | **高** |

---

### 3.2 典型分割パターン

#### パターンA：機能分割（推奨）

| 機能         | 基盤  |
| ---------- | --- |
| Web / 管理画面 | ECS |
| 外部API      | EKS |
| 内部API      | EKS |
| バッチ        | ECS |

---

#### パターンB：段階移行

```
Phase1: ECSのみ
Phase2: EKS追加
Phase3: ECS縮退
```

---

## 4. ネットワーク設計（厳格）

### 4.1 VPC設計

| 領域  | 設計              |
| --- | --------------- |
| ALB | Public Subnet   |
| ECS | Private Subnet  |
| EKS | Private Subnet  |
| DB  | Isolated Subnet |

※ **ECS / EKS は同一VPC可（管理分離）**

---

### 4.2 通信制御

| 通信        | 制御            |
| --------- | ------------- |
| ALB → ECS | SG            |
| ALB → EKS | SG            |
| ECS → EKS | Private通信のみ   |
| EKS内部     | NetworkPolicy |

---

## 5. ALB / WAF ルーティング設計

### 5.1 パス分岐例

```text
/app/*     → ECS
/api/*     → EKS
/admin/*   → ECS（社内IP）
```

---

### 5.2 WAF分離

| 対象    | WebACL |
| ----- | ------ |
| ECS   | Web用   |
| EKS   | API厳格  |
| Admin | 超厳格    |

---

## 6. CI/CD 分離設計

| 項目       | ECS        | EKS        |
| -------- | ---------- | ---------- |
| Build    | 共通         |            |
| Deploy   | CodeDeploy | ArgoCD     |
| Rollback | Service    | Git Revert |
| 承認       | 簡易         | 厳格         |

---

## 7. 監査・セキュリティ（金融／公共）

### 7.1 統制ポイント

| 観点  | 対応                 |
| --- | ------------------ |
| 権限  | IAM分離              |
| ログ  | CloudWatch + Audit |
| 変更  | IaC必須              |
| WAF | 分離ACL              |
| 監査  | SecurityHub        |

---

### 8. コスト設計（現実解）

| 規模 | ECS | EKS |
| -- | --- | --- |
| 小  | 安い  | 割高  |
| 中  | 最適  | 最適  |
| 大  | 割高  | 安い  |

👉 **初期はECS寄りが現実的**

---

## 9. よくある失敗と回避策

| 失敗    | 回避        |
| ----- | --------- |
| 役割曖昧  | 初期に責務定義   |
| WAF共用 | 必ず分離      |
| 運用属人化 | Runbook整備 |
| EKS乱立 | 役割単位      |

---

## 10. 最終結論（設計指針）

> **「ECSは安定稼働装置、EKSは進化装置」**

| フェーズ | 選択  |
| ---- | --- |
| 既存移行 | ECS |
| 機能拡張 | EKS |
| 厳格制御 | EKS |
| 安定運用 | ECS |

---
