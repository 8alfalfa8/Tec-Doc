# ◆ 監査・セキュリティ観点

以下は、**AWS EKS × ALB Ingress × Tomcat（WAR）構成**を前提にした
**監査・セキュリティ観点の整理**です。

単なるチェックリストではなく、

* **なぜその対策が必要か（監査視点）**
* **どこで・何を設定するか（技術視点）**
* **成果物として何を残すか（証跡視点）**

まで含めて、**ISMS／SOC2／内部監査／顧客監査対応で使えるレベル**で整理しています。

---

## 1. 監査・セキュリティ全体像

### 1.1 レイヤ別整理

| レイヤ         | 主対象               |
| ----------- | ----------------- |
| AWSアカウント    | IAM / CloudTrail  |
| ネットワーク      | VPC / ALB / SG    |
| EKS制御プレーン   | API Server / RBAC |
| Worker Node | EC2 / OS          |
| Kubernetes  | Namespace / Pod   |
| アプリ         | Tomcat / WAR      |
| 運用          | 監視 / ログ / 変更管理    |

---

## 2. 監査観点マッピング（俯瞰）

| 監査観点     | 対応要素                 |
| -------- | -------------------- |
| 認証・認可    | IAM / RBAC / IRSA    |
| ネットワーク制御 | VPC / SG / Ingress   |
| データ保護    | TLS / Secrets        |
| ログ・証跡    | CloudTrail / CW Logs |
| 変更管理     | GitOps / CI/CD       |
| 可用性      | Multi-AZ / HPA       |
| 脆弱性管理    | Image Scan / Patch   |
| インシデント対応 | Runbook              |

---

## 3. AWSアカウント／IAM（最重要）

### 3.1 IAM設計（監査必須）

### 監査観点

* **誰が・何に・いつアクセスしたか**
* **最小権限が守られているか**

#### 設計ポイント

| 対象   | 対策             |
| ---- | -------------- |
| 管理者  | IAM Role + MFA |
| 開発者  | 権限分離           |
| Pod  | IRSA           |
| Root | 使用禁止           |

#### IRSA（Pod単位IAM）

```
Pod → ServiceAccount → IAM Role
```

**監査メリット**

* アプリ単位で責任分離
* APIアクセスの追跡可能

#### 成果物

* IAMロール設計書
* 権限一覧表（Role × Policy）

---

### 3.2 CloudTrail（必須）

#### 設定

* 全リージョン
* 管理イベント + データイベント
* S3保存（改ざん不可）

#### 監査ポイント

* EKS操作（CreateCluster, UpdateNodegroup）
* IAM変更履歴

#### 成果物

* CloudTrail有効化証跡
* ログ保存ポリシー

---

## 4. ネットワーク・通信制御

### 4.1 VPC / Subnet

| 項目   | 設計             |
| ---- | -------------- |
| Node | Private Subnet |
| ALB  | Public Subnet  |
| DB   | Private Subnet |

**監査理由**
→ 外部から直接Nodeへ侵入不可

---

### 4.2 Security Group（SG）

#### ALB SG

| In | 443 |
| Out | Node SG |

#### Node SG

| In | ALB SG |
| Out | 必要最小限 |

#### 監査ポイント

* `0.0.0.0/0` の過剰使用がないか

#### 成果物

* SG設計図
* SGルール一覧

---

### 4.3 Ingress / ALB

#### 必須設定

| 項目    | 内容       |
| ----- | -------- |
| HTTPS | 強制       |
| TLS   | ACM      |
| HTTP  | Redirect |

#### WAF（推奨）

* SQL Injection
* XSS
* Bot制御

#### 成果物

* Ingress設計書
* WAFルール定義

---

## 5. EKS制御プレーン・Kubernetes

### 5.1 API Server監査ログ

#### 有効化ログ

| 種別            | 目的    |
| ------------- | ----- |
| audit         | 操作証跡  |
| authenticator | 認証追跡  |
| api           | API操作 |

#### 監査質問対応例

> 「誰がPodを削除しましたか？」

→ CloudWatch Logsで即回答可

---

### 5.2 RBAC設計

#### 原則

* namespace単位
* Role / RoleBinding使用
* cluster-admin最小化

#### 監査観点

* 誰が `kubectl delete` できるか

#### 成果物

* RBAC定義YAML
* 権限マトリクス表

---

### 5.3 Namespace分離

| Namespace | 用途 |
| --------- | -- |
| prod      | 本番 |
| stg       | 検証 |
| ops       | 監視 |

**監査メリット**

* 誤操作防止
* 責任範囲明確化

---

## 6. Secrets・機密情報管理

### 6.1 Secrets管理方針

| 情報      | 管理                |
| ------- | ----------------- |
| DBパス    | Kubernetes Secret |
| API Key | Secrets Manager   |
| 証明書     | ACM               |

#### NG例

* ConfigMapに平文記載
* Git管理

#### 監査成果物

* Secrets管理ポリシー
* 登録・更新手順書

---

## 7. ログ・監視・証跡管理

### 7.1 ログ収集

| ログ         | 保存先        |
| ---------- | ---------- |
| Pod stdout | CloudWatch |
| ALB Access | S3         |
| CloudTrail | S3         |

#### 要件

* 改ざん防止
* 保存期間明示（例：1年）

---

### 7.2 監視・アラート

| 対象   | アラート       |
| ---- | ---------- |
| ALB  | 5xx        |
| Pod  | CrashLoop  |
| Node | Disk / CPU |

---

## 8. 脆弱性管理

### 8.1 コンテナイメージ

| 対策         | 内容        |
| ---------- | --------- |
| Base Image | 公式        |
| Scan       | ECR Scan  |
| 更新         | 定期Rebuild |

#### 監査成果物

* 脆弱性診断結果
* 対応履歴

---

### 8.2 OS / Node

* Managed Node Group
* 自動更新
* AMI最新化

---

## 9. 変更管理・CI/CD監査

### 9.1 GitOps原則

```
変更 = Git Commit
```

#### 監査メリット

* 誰が・いつ・何を変更したか明確

---

### 9.2 CI/CD証跡

| 項目       | 証跡  |
| -------- | --- |
| Build    | Log |
| Deploy   | Log |
| Rollback | 手順  |

---

## 10. インシデント対応（監査で必ず聞かれる）

### 10.1 Runbook整備

| 事象   | 手順         |
| ---- | ---------- |
| 侵入疑い | 権限停止       |
| 障害   | Rollback   |
| ログ調査 | CloudWatch |

---

## 11. 監査向け成果物一覧

* AWS/EKSセキュリティ設計書
* IAM/RBAC一覧表
* CloudTrail設定証跡
* Ingress/WAF設計書
* Secrets管理方針
* ログ保存ポリシー
* インシデント対応Runbook

---

## 12. よくある監査指摘と対策

| 指摘     | 対策              |
| ------ | --------------- |
| 権限過剰   | IRSA/RBAC       |
| ログ不足   | Auditログ         |
| 証跡不明   | GitOps          |
| 平文秘密情報 | Secrets Manager |

---
