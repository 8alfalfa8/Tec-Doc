# ◆ WAF × ALB × Ingressの責務分離

以下では、**AWS WAF × ALB × EKS Ingress**（**AWS Load Balancer Controller**）における
**責務分離**（**Responsibility Separation**）を、

* 設計原則
* レイヤ別責務定義
* 具体的な設定範囲
* 変更・運用・監査観点
* よくあるアンチパターン

まで含めて、**設計書としてそのまま使える形**で整理します。

---

## 1. なぜ「責務分離」が重要か

### 1.1 背景（実務的理由）

| 課題        | 責務分離で解決    |
| --------- | ---------- |
| 影響範囲が不明   | 変更点が特定可能   |
| 誤検知対応が困難  | レイヤ単位で切り分け |
| 監査説明が複雑   | 役割明確化      |
| 障害切り分けが遅い | 責務単位で調査    |

👉 **「どこで何を止めるか」を決める設計**が最重要

---

## 2. 全体構成と責務レイヤ

```
[ Client ]
    ↓
[ WAF ]        ← 攻撃検知・遮断
    ↓
[ ALB ]        ← L7ロードバランス
    ↓
[ Ingress ]    ← K8sルーティング
    ↓
[ Service ]
    ↓
[ Pod ]
```

---

## 3. レイヤ別責務定義（要点）

| レイヤ     | 主責務  | 非責務      |
| ------- | ---- | -------- |
| WAF     | 攻撃遮断 | ルーティング   |
| ALB     | 負荷分散 | 攻撃判定     |
| Ingress | 経路制御 | セキュリティ判定 |

---

## 4. WAFの責務（Security Gate）

### 4.1 担当領域

| 項目    | 内容          |
| ----- | ----------- |
| 攻撃検知  | SQLi / XSS  |
| 異常通信  | Rate Limit  |
| Bot対策 | Bot Control |
| 地理制限  | Geo制御       |

#### 原則

* **「悪い通信を入れない」**
* パス・IP・UAレベル

---

### 4.2 WAFでやるべきこと

✅ やる

* SQL Injection遮断
* 管理画面への不正アクセス遮断
* DDoS軽減

❌ やらない

* パスの振り分け
* URL設計ロジック

---

### 4.3 設定例

```text
Rule: Block SQLi
Rule: RateLimit /login
```

---

## 5. ALBの責務（Traffic Manager）

### 5.1 担当領域

| 項目       | 内容           |
| -------- | ------------ |
| HTTPS終端  | TLS          |
| Listener | 80 / 443     |
| 負荷分散     | Target Group |
| 冗長性      | Multi-AZ     |

#### 原則

* **「正しい通信を安定的に流す」**

---

### 5.2 ALBでやるべきこと

✅ やる

* HTTPS強制
* ヘルスチェック
* Idle Timeout調整

❌ やらない

* 攻撃検知ロジック
* 複雑なビジネス分岐

---

### 5.3 設定例

```text
Listener: 443
HealthCheck: /health
```

---

## 6. Ingressの責務（Routing Controller）

### 6.1 担当領域

| 項目        | 内容              |
| --------- | --------------- |
| パス制御      | /api /app       |
| Host制御    | app.example.com |
| Service連携 | ClusterIP       |

#### 原則

* **「どこに流すかを決める」**

---

### 6.2 Ingressでやるべきこと

✅ やる

* パスベース振り分け
* Hostベース制御
* Service切替

❌ やらない

* セキュリティ制御
* Rate制御

---

### 6.3 設定例

```yaml
rules:
- host: app.example.com
  http:
    paths:
    - path: /api
      backend: api-service
```

---

## 7. 責務分離マトリクス（完全版）

| 機能     | WAF | ALB | Ingress |
| ------ | --- | --- | ------- |
| SQLi対策 | ◎   | ×   | ×       |
| DDoS   | ◎   | △   | ×       |
| HTTPS  | ×   | ◎   | ×       |
| パス分岐   | ×   | △   | ◎       |
| セッション  | ×   | ×   | ×       |
| 冗長     | △   | ◎   | △       |

---

## 8. 変更・運用観点での責務分離

### 8.1 変更影響

| 変更      | 影響   |
| ------- | ---- |
| WAFルール  | 通信可否 |
| ALB設定   | 可用性  |
| Ingress | 経路   |

👉 影響範囲が明確になる

---

### 8.2 障害切り分けフロー

```
アクセス不可
  ↓
WAFログ確認
  ↓
ALBヘルス
  ↓
Ingressルール
  ↓
Pod
```

---

## 9. 監査・説明時の定型説明文（メモ）

> WAFは外部からの不正通信を遮断するセキュリティレイヤ、
> ALBは正規通信を安定的に分散するトラフィック制御レイヤ、
> IngressはKubernetes内でのアプリケーションルーティングを担います。
> 各レイヤの責務を分離することで、セキュリティと運用性を両立しています。

---

## 10. よくあるアンチパターン

| パターン         | 問題   |
| ------------ | ---- |
| IngressでIP制限 | 分散不可 |
| ALBで攻撃判定     | 機能不足 |
| WAFでパス分岐     | 保守不能 |

---

## 11. 成果物

* 責務分離図
* レイヤ別設定一覧
* 変更影響表
* 障害切り分けフロー

---
