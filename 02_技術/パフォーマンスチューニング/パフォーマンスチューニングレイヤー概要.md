# ◆ パフォーマンスチューニングレイヤー概要

以下では、**エンタープライズ系／大規模業務システム（オンプレ・AWS双方を想定）**を前提に、
**パフォーマンスチューニングを「レイヤー別」**に整理し、各レイヤーごとに

* 役割・チューニング観点
* よく発生する問題
* 具体的な作業タスク
* 作業内容・方法
* 指標（KPI / メトリクス）
* 成果物

を**実務レベル**で詳しく説明します。
（※**AWS移行・大規模業務システム・RFP/設計レビュー視点** にもそのまま使える構成です）

---

## 1. パフォーマンスチューニング全体像（レイヤー構造）

```
┌─────────────────────────┐
│ ① ビジネス / 要件レイヤー │  ← SLO / SLA
├─────────────────────────┤
│ ② アプリケーションレイヤー│
├─────────────────────────┤
│ ③ ミドルウェアレイヤー    │
├─────────────────────────┤
│ ④ データベースレイヤー    │
├─────────────────────────┤
│ ⑤ インフラ / OSレイヤー   │
├─────────────────────────┤
│ ⑥ ネットワークレイヤー    │
├─────────────────────────┤
│ ⑦ 運用・監視レイヤー      │
└─────────────────────────┘
```

---

## 2. ① ビジネス／要件レイヤー

### 役割・観点

* 「**速い／遅いの定義**」を決める
* 技術チューニングの**ゴール設定**

---

### よくある問題

| 問題       | 内容                 |
| -------- | ------------------ |
| 要求が曖昧    | 「速くしてほしい」「レスポンス改善」 |
| 業務ピーク未定義 | 月末・朝一・バッチ時間が不明     |
| 重要画面が不明  | 全画面同じ優先度           |

---

### 作業タスク

* 業務フロー分析
* 重要トランザクション特定
* SLO / SLA 定義
* 負荷条件定義

---

### 作業内容・方法

* 業務担当ヒアリング
* トランザクション分解（検索／登録／集計）
* ピーク同時利用数算出
* SLA文書化

---

### 指標（例）

| 指標     | 目安        |
| ------ | --------- |
| 画面応答時間 | 2秒以内      |
| API応答  | 500ms以内   |
| バッチ処理  | 〇時までに完了   |
| 同時接続数  | 1,000ユーザー |

---

### 成果物

* 非機能要件定義書
* SLO / SLA定義書
* 負荷条件一覧

---

## 3. ② アプリケーションレイヤー

### 役割・観点

* **処理ロジック・I/O・非同期化**
* 無駄な処理・冗長処理の削減

---

### よくある問題

| 問題     | 具体例          |
| ------ | ------------ |
| N+1問題  | ループ内DBアクセス   |
| 重い同期処理 | ファイル出力・外部API |
| 不要な再計算 | 毎回同じ計算       |
| メモリリーク | キャッシュ解放漏れ    |

---

### 作業タスク

* コードレビュー
* プロファイリング
* 非同期化設計
* キャッシュ導入

---

## 作業内容・方法

* APM（New Relic / Datadog）分析
* JVM / Python Profiler
* 非同期処理（Queue, Batch化）
* キャッシュ（Redis, In-Memory）

---

### 指標

| 指標     | 内容         |
| ------ | ---------- |
| 処理時間   | API/メソッド単位 |
| スループット | TPS        |
| GC時間   | JVM        |
| メモリ使用量 | Heap / RSS |

---

### 成果物

* 改修設計書
* 改善前後比較レポート
* コード修正差分

---

## 4. ③ ミドルウェアレイヤー（Web/AP）

### よくある問題

| 問題        | 内容           |
| --------- | ------------ |
| コネクション枯渇  | DB接続不足       |
| スレッド不足    | 同時処理不可       |
| タイムアウト不整合 | Web/AP/DB不一致 |

---

### 作業タスク

* 設定値見直し
* プール調整
* タイムアウト統一

---

### 作業内容・方法

* Tomcat / Nginx / Gunicorn設定
* Connection Pool調整
* KeepAlive / Timeout調整

---

### 指標

| 指標              | 内容  |
| --------------- | --- |
| Active Threads  | 使用率 |
| Connection Pool | 利用率 |
| Error率          | 5xx |

---

### 成果物

* 設定変更差分
* チューニング手順書

---

## 5. ④ データベースレイヤー（最重要）

### よくある問題

| 問題       | 具体例      |
| -------- | -------- |
| インデックス不足 | フルスキャン   |
| 不適切なSQL  | SELECT * |
| ロック競合    | 更新集中     |
| パラメータ未調整 | バッファ不足   |

---

### 作業タスク

* SQL分析
* 実行計画確認
* インデックス設計
* パラメータ調整

---

### 作業内容・方法

* EXPLAIN / AWR / Performance Insights
* スロークエリ抽出
* 正規化/非正規化検討
* Read/Write分離

---

### 指標

| 指標    | 内容        |
| ----- | --------- |
| クエリ時間 | p95/p99   |
| ロック待ち | Wait Time |
| IOPS  | 読書        |
| CPU   | DB負荷      |

---

### 成果物

* SQL改善一覧
* インデックス設計書
* 実行計画比較

---

# 6. ⑤ インフラ／OSレイヤー

### よくある問題

| 問題       | 内容         |
| -------- | ---------- |
| リソース不足   | CPU/Memory |
| ストレージ遅延  | IOPS不足     |
| オーバースペック | 無駄コスト      |

---

### 作業タスク

* リソース分析
* スケール設計
* OSチューニング

---

### 指標

| 指標     | 内容           |
| ------ | ------------ |
| CPU    | 使用率          |
| Memory | Swap         |
| Disk   | IOPS/Latency |

---

### 成果物

* インフラ構成見直し案
* コスト影響分析

---

## 7. ⑥ ネットワークレイヤー

### よくある問題

* レイテンシ過多
* LB設定不備
* クロスAZ通信増大

---

### 指標

* RTT
* パケットロス
* Throughput

---

### 成果物

* ネットワーク構成改善案

---

## 8. ⑦ 運用・監視レイヤー（継続改善）

### 役割

* **再発防止・予兆検知**

---

### 作業タスク

* KPI定義
* アラート設計
* Runbook整備

---

### 成果物

* 監視設計書
* 障害対応Runbook
* 定期性能レポート

---

## 9. まとめ

> 「パフォーマンスチューニングは、単なる速度改善ではなく、
> **ビジネス要件から各技術レイヤーまで一貫してKPIを定義し、
> 計測 → 仮説 → 改善 → 検証を回す継続プロセス** だと考えています。」

---
