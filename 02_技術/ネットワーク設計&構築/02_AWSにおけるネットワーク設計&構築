# 02_AWSにおけるネットワーク設計&構築の概要

AWSにおけるネットワーク設計/構築について、従来のオンプレミス環境とは異なるクラウドネイティブな観点で、要件定義からテスト検証まで詳細に説明します。

---

## **1. 要件定義**

AWSネットワーク設計の出発点であり、ビジネスと技術の要件を明確にします。

### **主要検討項目**
*   **ビジネスドライバ**
    *   コスト最適化 vs パフォーマンス/可用性最優先
    *   コンプライアンス要件 (SOC, PCI DSS, ISO27001など)
    *   リソースの展開範囲 (リージョン、アベイラビリティーゾーン(AZ))
*   **ワークロード特性**
    *   アプリケーションのアーキテクチャ (モノリス vs マイクロサービス)
    *   通信パターン (東西トラフィック vs 南北トラフィック)
    *   想定トラフィック量とスパイクパターン
*   **可用性と耐障害性**
    *   Recovery Time Objective (RTO) / Recovery Point Objective (RPO)
    *   単一AZ障害への耐性 (マルチAZ構成の要否)
    *   リージョン障害への耐性 (マルチリージョン/ディザスタリカバリ構成の要否)
*   **セキュリティとガバナンス**
    *   データ分類とセキュリティレベル
    *   インターネット接続要件 (パブリック/プライベートサブネット)
    *   ハイブリッド接続 (オンプレミス接続) 要件 (AWS Direct Connect, VPN)
    *   監査とログ取得要件 (VPC Flow Log, AWS CloudTrail)
*   **運用と管理**
    *   インフラ as Code (IaC) の適用 (Terraform, AWS CDK)
    *   ネットワーク変更管理プロセス
    *   監視とアラート体制 (Amazon CloudWatch)

---

## **2. 基本設計**

要件を基に、AWSのネットワーク基盤の大枠を設計します。ここでは**VPCを中心**に考えます。

### **VPC設計**
*   **IPアドレス設計 (CIDRブロック)**
    *   将来の拡張性を見据えた十分な大きさのCIDRブロックを選択 (例: `/16`)
    *   オンプレミスや他VPC、将来の接続先との重複を回避
    *   VPCピアリング接続を考慮
*   **サブネット設計**
    *   **パブリックサブネット**: インターネットゲートウェイ(IGW)へのルートを持つ。ELB、NAT Gatewayなどが配置される。
    *   **プライベートサブネット**: インターネットへの直接ルートがない。アプリケーションサーバー、データベースなどが配置される。
    *   **AZごとのサブネット分割**: 高可用性のため、各サブネットを複数AZに跨って作成 (例: `private-subnet-1a`, `private-subnet-1c`)。
*   **ルーティング設計**
    *   ルートテーブルをサブネットごとに設計
    *   パブリックサブネット: `0.0.0.0/0 -> igw-xxxxx`
    *   プライベートサブネット: `0.0.0.0/0 -> nat-xxxxx` (NAT Gateway経由)

### **セキュリティ設計**
*   **セキュリティグループ (SG)**
    *   EC2インスタンスレベルでのステートフルな仮想ファイアウォール
    *   「許可」ポリシーのみ定義 (例: SG for Web: 80/443 from 0.0.0.0/0)
    *   最小権限の原則に基づく設定
*   **ネットワークACL (NACL)**
    *   サブネットレベルでのステートレスなフィルタリング
    *   特定のIPからのアクセス遮断など、追加の防御層として利用

---

## **3. 詳細設計**

基本設計で決まった方針を、具体的なAWSサービスと設定に落とし込みます。

### **L3 (ルーティング) の詳細設計**
*   **インターネット接続**
    *   **インターネットゲートウェイ (IGW)**: VPCとインターネット間の通信を可能にする。
*   **プライベートサブネットのアウトバウンド接続**
    *   **NAT Gateway**: マネージド型のNATサービス。冗長化のため、AZごとに配置し、各AZのプライベートサブネットからは同じAZのNAT Gatewayを参照させる。
*   **ハイブリッド接続 (オンプレミス接続)**
    *   **AWS VPN**: インターネット経由の安全なIPsec接続。サイト間VPN。
    *   **AWS Direct Connect (DX)**: 専用線によるプライベート接続。高帯域幅、低遅延、安定性が要求される場合に採用。
    *   **Transit Gateway**: 多数のVPCやオンプレミスネットワークを中央集権的に接続するハブアンドスポークモデルを構築する際の中核サービス。
*   **VPC間接続**
    *   **VPC Peering**: 異なるVPC間の直接接続。CIDRが重複してはいけない。
    *   **Transit Gateway**: 大規模で複雑なVPC間接続を効率化。

### **L2の考慮点 (AWSでは抽象化)**
*   AWSではハイパーバイザーネットワークがL2を抽象化しているため、物理的なL2スイッチの設定は不要。
*   同一サブネット内の通信はAWSが透過的に処理。
*   **注意点**:  Broadcast/Multicastがサポートされていないため、それらを前提としたレガシーアプリケーションは調整が必要。

### **ファイアウォール (FW) の詳細設計**
*   **ネットワークフィアウォール (NWFW)**
    *   サブネット間やVPC間のトラフィックを詳細に制御できるマネージド型FW。
    *   深パケットインスペクション(DPI)や独自のルールセットで高度な防御が可能。
*   **Gateway Load Balancer (GWLB)**
    *   サードパーティ製FWアプライアンス (Fortinet, Palo Alto等) を透過的に導入するためのサービス。
    *   トラフィックを複数のFWアプライアンスに振り分け、スケーラビリティと冗長性を提供。
*   **WAF (Web Application Firewall)**
    *   Application Load Balancer (ALB) やCloudFrontと連携し、Webアプリケーション層の防御 (SQLインジェクション、XSS等) を担当。

### **ロードバランサー (LB) の詳細設計**
*   **Application Load Balancer (ALB)**
    *   Layer7 (HTTP/HTTPS) での負荷分散。パスベースルーティング (`/api/*` はバックエンドサーバーへ) やホストベースルーティングが可能。
    *   マイクロサービスコンテナアーキテクチャとの親和性が高い。
*   **Network Load Balancer (NLB)**
    *   Layer4 (TCP/UDP) での超低遅延・高パフォーマンスな負荷分散。
    *   固定IPアドレスを保持できるため、IPベースの許可リストが必要な外部システム連携に有効。
    *   GWLBの構成要素としても利用。
*   **Gateway Load Balancer (GWLB)**
    *   上述の通り、サードパーティ製仮想アプライアンスのためのロードバランサー。

---

## **4. 構築・設定**

設計を元に、実際の環境を構築します。**手動でのコンソール操作は非推奨**です。

### **インフラ as Code (IaC) による構築**
*   **Terraform**
    *   マルチクラウドや宣言型の記述を好む場合に強力。
    *   `aws_vpc`, `aws_subnet`, `aws_route_table`, `aws_security_group` などのリソースを定義。
*   **AWS CloudFormation**
    *   AWSネイティブのIaCサービス。AWSリソース間の依存関係の解決に優れる。
    *   CloudFormationテンプレート (YAML/JSON) を作成。
*   **AWS CDK (Cloud Development Kit)**
    *   プログラミング言語 (TypeScript, Python等) でインフラを定義できる。

### **構築手順の例 (Terraformの考え方)**
1.  **VPC & サブネット作成**: VPCと、パブリック/プライベートサブネットを各AZに作成。
2.  **ゲートウェイ設定**: IGW, NAT Gateway (EIPと紐付け) を作成・設定。
3.  **ルートテーブル設定**: パブリック/プライベート用のルートテーブルを作成し、適切なサブネットに関連付け。
4.  **セキュリティグループ作成**: Web, App, DB層ごとにSGを作成し、必要なインバウンド/アウトバウンドルールを定義。
5.  **ロードバランサー構築**: ALB/NLBを作成し、パブリックサブネットに配置。ターゲットグループを作成し、ヘルスチェックを設定。
6.  **その他サービス構築**: 必要に応じて、Transit Gateway, Direct Connect, NWFWなどを構築。

---

## **5. テスト・検証**

構築した環境が設計通りに動作し、要件を満たしているかを確認する重要な工程です。

### **接続性テスト**
*   **内部接続性**: 同一サブネット内、異なるサブネット間の通信を確認。
    *   `ping` (ICMP), `telnet` (TCPポート), `traceroute` コマンドを利用。
*   **インターネット接続性**
    *   パブリックサブネットのEC2からインターネットへのアクセスを確認。
    *   プライベートサブネットのEC2からNAT Gateway経由でのインターネットアクセス (`yum update` 等) を確認。
*   **オンプレミス接続性**: VPN/Direct Connect経由でのオンプレミスからのアクセスを確認。
*   **ロードバランサー経由の接続**: パブリックALBのDNS名にブラウザやcurlでアクセスし、背後にあるEC2に接続できるか確認。

### **フェイルオーバー試験**
*   **AZ障害シミュレーション**: あるAZのEC2インスタンスを停止し、他AZのインスタンスにトラフィックが自動的に流れるか (ALB/ターゲットグループの動作) を確認。
*   **NAT Gateway障害シミュレーション**: プライベートサブネットから、異なるAZのNAT Gatewayを経由するようにルートを変更し、通信が継続するか確認 (設計段階で考慮済みであることが前提)。
*   **インスタンス障害シミュレーション**: ターゲットグループ内のインスタンス1台を停止し、ヘルスチェックで検知され、トラフィックの振り分け対象から外れるかを確認。

### **性能テスト**
*   **負荷テスト**: Apache Bench, JMeter等を用いてALB/NLBに対して負荷をかけ、設計通りの性能・スケーリングが行われるかを確認。
*   **帯域幅テスト**: 大容量ファイルの転送等を行い、NAT GatewayやDirect Connectの帯域幅が期待通りかを確認。

### **セキュリティテスト**
*   **SG/NACLテスト**: 意図的に許可されていないポートやIPからのアクセス試行を行い、通信が遮断されることを確認。
*   **設定監査**: AWS Configやセキュリティハブを利用し、設計から外れた設定 (不適切なS3バケットポリシー、公開されているRDS等) がないかを確認。

この一連のプロセスを通じて、AWSクラウド上に、堅牢でセキュア、かつ高可用性なネットワークインフラを構築・運用することが可能となります。
