# ◆ 詳細設計書（Salesforce：オブジェクト／Flow／Apex対応）

以下では、**CRM詳細設計書（Salesforce：オブジェクト／Flow／Apex 対応）**について、
**金融・公共／中大規模プロジェクトでもそのまま使えるレベル**で、

* 章立て（テンプレート）
* 各章の記載内容
* Salesforce特有の設計観点
* レビュー・監査で見られるポイント

を体系的に整理します。

---

## CRM詳細設計書

### （Salesforce：オブジェクト／Flow／Apex 対応版）

---

### 0. 本書の位置づけ（重要）

| 項目   | 内容                                      |
| ---- | --------------------------------------- |
| 工程   | 詳細設計                                    |
| 上位文書 | 要件定義書、基本設計書（Salesforce方式設計）             |
| 対象   | Salesforce標準＋カスタム開発                     |
| 主対象  | 実装者（設定担当／Apex開発者）、テスト担当                 |
| 特徴   | 「設定（Declarative）」と「開発（Programmatic）」の両立 |

---

### 1. 概要

#### 1.1 目的

* Salesforce上で実装する
  **オブジェクト構造／業務ロジック／自動化処理／カスタムコード**を
  実装レベルまで具体化する

#### 1.2 適用範囲

* 標準オブジェクト
* カスタムオブジェクト
* Flow（画面／レコードトリガ／スケジュール）
* Apex（Trigger／Class／Batch等）

---

### 2. 全体構成・設計方針

#### 2.1 Salesforce設計原則

| 原則      | 内容                          |
| ------- | --------------------------- |
| 宣言的優先   | Flow / 標準機能で実現可能ならApexは使わない |
| ガバナ制限考慮 | SOQL回数、DML回数、CPU Time       |
| 将来拡張性   | 項目追加・業務変更を想定                |
| 権限制御分離  | プロファイル最小化＋権限セット             |

---

### 3. オブジェクト詳細設計

#### 3.1 オブジェクト一覧

| No | 種別   | API名               | 表示名    | 用途    |
| -- | ---- | ------------------ | ------ | ----- |
| 1  | 標準   | Account            | 取引先    | 顧客マスタ |
| 2  | 標準   | Contact            | 取引先責任者 | 担当者   |
| 3  | カスタム | Opportunity_Ext__c | 商談拡張   | 業務固有  |
| …  |      |                    |        |       |

---

#### 3.2 オブジェクト定義（個別）

##### ■ オブジェクト基本情報

| 項目    | 内容                 |
| ----- | ------------------ |
| API名  | Opportunity_Ext__c |
| 表示名   | 商談拡張               |
| 種別    | カスタム               |
| データ所有 | 参照（商談）             |
| 共有設定  | 親に従う               |

---

#### 3.3 項目定義

| No | 論理名   | API名                 | 型  | 桁数   | 必須 | 初期値 | 備考      |
| -- | ----- | -------------------- | -- | ---- | -- | --- | ------- |
| 1  | 契約金額  | ContractAmount__c    | 通貨 | 15,2 | ○  | -   | 商談金額と一致 |
| 2  | 契約開始日 | ContractStartDate__c | 日付 | -    | ○  | -   |         |

**注意事項**

* 数値項目は必ず桁数根拠を明記
* 通貨／多通貨利用有無を明示

---

#### 3.4 関連・リレーション設計

| 親           | 子                  | 関係 | 削除時    |
| ----------- | ------------------ | -- | ------ |
| Opportunity | Opportunity_Ext__c | 主従 | 親削除で削除 |

---

#### 3.5 入力規則・検証ルール

| No | 条件       | エラーメッセージ          |
| -- | -------- | ----------------- |
| 1  | 契約金額 < 0 | 契約金額は0以上で入力してください |

---

### 4. 画面（UI）詳細設計

#### 4.1 ページレイアウト

| レイアウト名 | 対象プロファイル |
| ------ | -------- |
| 商談_営業用 | 営業       |
| 商談_管理用 | 管理者      |

#### 4.2 Lightning Record Page

| セクション | コンポーネント    |
| ----- | ---------- |
| 上部    | ハイライトパネル   |
| 中央    | 詳細／関連リスト   |
| 右     | Flow（補助入力） |

---

### 5. Flow詳細設計

#### 5.1 Flow一覧

| No | 種別      | 名称     | トリガ   |
| -- | ------- | ------ | ----- |
| 1  | レコードトリガ | 商談更新処理 | 商談更新時 |
| 2  | 画面Flow  | 契約登録   | ボタン起動 |

---

#### 5.2 Flow個別設計（例）

##### ■ 基本情報

| 項目      | 内容          |
| ------- | ----------- |
| Flow名   | 商談更新連動処理    |
| 種別      | レコードトリガ     |
| 実行タイミング | After Save  |
| 対象      | Opportunity |

---

##### ■ 処理フロー

1. 商談更新検知
2. ステージ変更判定
3. 契約情報自動生成
4. 完了

##### ■ 分岐条件

| 条件        | 内容   |
| --------- | ---- |
| ステージ = 成約 | True |

---

#### 5.3 Flow設計上の注意

* Loop内でのDML禁止
* Get Recordsは必要最小限
* 再帰防止フラグ設計

---

### 6. Apex設計

#### 6.1 Apex利用方針

| 項目      | 方針                 |
| ------- | ------------------ |
| Trigger | 1オブジェクト1Trigger    |
| ロジック    | Trigger Handlerに集約 |
| Flow連携  | Invocable Method   |

---

#### 6.2 Apexクラス一覧

| No | 種別      | クラス名                      | 用途   |
| -- | ------- | ------------------------- | ---- |
| 1  | Handler | OpportunityTriggerHandler | 商談処理 |
| 2  | Service | ContractService           | 契約生成 |
| 3  | Batch   | ContractBatch             | 夜間処理 |

---

#### 6.3 Trigger設計

```text
OpportunityTrigger
 └ OpportunityTriggerHandler
     ├ beforeInsert
     ├ beforeUpdate
     ├ afterUpdate
```

**設計ポイント**

* Trigger内ロジック禁止
* Context判定はHandler側

---

#### 6.4 クラス詳細設計（例）

| 項目   | 内容               |
| ---- | ---------------- |
| クラス名 | ContractService  |
| 可視性  | public           |
| 役割   | 契約データ生成          |
| 例外   | 業務例外は独自Exception |

---

#### 6.5 ガバナ制限対策

| 項目   | 対策         |
| ---- | ---------- |
| SOQL | forループ外で取得 |
| DML  | 一括更新       |
| CPU  | 複雑分岐削減     |

---

### 7. 権限・セキュリティ詳細

#### 7.1 権限セット

| 権限セット     | 対象 |
| --------- | -- |
| CRM_Sales | 営業 |
| CRM_Admin | 管理 |

#### 7.2 項目レベルセキュリティ

| 項目   | 参照 | 更新    |
| ---- | -- | ----- |
| 契約金額 | ○  | 管理者のみ |

---

### 8. テスト観点（詳細設計レベル）

#### 8.1 単体テスト対象

| 対象     | 内容    |
| ------ | ----- |
| オブジェクト | 入力規則  |
| Flow   | 分岐網羅  |
| Apex   | 正常／異常 |

#### 8.2 Apexテスト要件

* カバレッジ 75%以上
* 正常系／例外系必須
* データ依存禁止（SeeAllData=false）

---

### 9. 成果物一覧

| No | 成果物        |
| -- | ---------- |
| 1  | CRM詳細設計書   |
| 2  | Flow構成図    |
| 3  | Apexクラス設計書 |
| 4  | 権限定義書      |

---

### 10. レビュー・監査チェック観点（超重要）

* Flowで実装できるのにApexを使っていないか
* ガバナ制限違反の可能性
* 権限過剰付与がないか
* 標準機能破壊（Trigger競合）がないか

---



---
