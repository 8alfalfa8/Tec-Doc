# ◆ ログ確認・トラブルシュート作業

ログ確認・トラブルシュート作業は、
**「事象の再現 → 影響範囲特定 → 原因特定 → 恒久対策」** という流れで体系的に実施します。

ここでは、

* オンプレミス
* クラウド（例：Amazon Web Services / Google Cloud / Oracle Cloud Infrastructure）
* アプリケーション層

を含めた実務レベルで詳細解説します。

---

## 1. ログ確認の目的

ログ確認の目的は大きく5つです。

| 目的     | 内容                 |
| ------ | ------------------ |
| 障害原因特定 | 例外、エラーコード、タイムアウト確認 |
| 影響範囲把握 | どのユーザー・機能が影響を受けたか  |
| 時系列整理  | いつから発生したか          |
| 再発防止   | 恒久対策のための根拠収集       |
| 証跡確保   | 監査・報告・ベンダー調整用      |

---

## 2. ログ確認の基本原則（極めて重要）

#### ① いきなり原因を決めつけない

「DBが悪いはず」などの思い込みは事故の元。

#### ② 時系列で追う

必ず以下順で確認：

```
発生時刻
↓
直前の変更
↓
関連コンポーネント
↓
エラー発生箇所
↓
依存サービス
```

#### ③ 影響範囲を先に確定

原因より先に、

* 全体障害か
* 一部ユーザーか
* 特定リージョンか

を把握します。

---

## 3. ログの種類（レイヤ別）

### ① OSログ（Linux例）

| ログ                | 内容      |
| ----------------- | ------- |
| /var/log/messages | システム全体  |
| /var/log/syslog   | Ubuntu系 |
| /var/log/secure   | 認証ログ    |
| dmesg             | カーネル    |

#### 確認コマンド例

```bash
tail -f /var/log/messages
grep ERROR application.log
journalctl -xe
```

---

### ② Webサーバログ

例：

* Apache
* Nginx

```
access.log
error.log
```

確認観点：

| 観点       | 内容     |
| -------- | ------ |
| 500エラー   | アプリ例外  |
| 502/504  | 上流接続不可 |
| レスポンスタイム | 遅延発生有無 |
| 特定IP集中   | 攻撃可能性  |

---

### ③ アプリケーションログ

Java例：

* stacktrace
* NullPointerException
* SQLエラー

確認観点：

```
Exception
ERROR
Timeout
Connection refused
```

---

### ④ データベースログ

* slow query
* deadlock
* connection pool枯渇
* ORA-エラー（Oracle）

---

### ⑤ クラウドログ

#### AWS例（Amazon Web Services）

| サービス            | 内容      |
| --------------- | ------- |
| CloudWatch Logs | アプリ/OS  |
| CloudTrail      | API操作履歴 |
| VPC Flow Logs   | 通信ログ    |
| ELBログ           | ロードバランサ |

#### GCP例（Google Cloud）

* Cloud Logging
* Audit Logs

---

## 4. トラブルシュートの標準手順（実務型）

### STEP1：事象整理（5W1H）

* いつ
* どこで
* 何が
* どのくらい
* 誰に

を必ず文章化

---

### STEP2：変更履歴確認（最重要）

障害の80%は変更起因。

確認対象：

* リリース
* パッチ適用
* 設定変更
* 証明書更新
* スケール変更
* ネットワーク変更

---

### STEP3：エラー特定

#### ログから抽出

```
grep -i error
grep -i exception
```

→ 例外の最上位行を確認
→ stacktraceの最初のCaused byを見る

---

### STEP4：依存関係確認

```
Web → App → DB → 外部API
```

どこで止まっているかを確認。

例：

| エラー                | 原因例    |
| ------------------ | ------ |
| 502                | App停止  |
| 504                | DB遅延   |
| Connection refused | ポート未起動 |

---

### STEP5：リソース確認

```bash
top
free -m
df -h
netstat -an
```

確認観点：

* CPU 100%
* メモリ不足
* ディスク枯渇
* ソケット枯渇

---

## 5. よくある障害パターン

| 症状       | 原因           |
| -------- | ------------ |
| 夜間のみ遅い   | バッチ競合        |
| 突然503    | スレッド枯渇       |
| DB接続不可   | セキュリティグループ変更 |
| 全API失敗   | 証明書期限切れ      |
| 一部ユーザーのみ | キャッシュ不整合     |

---

## 6. クラウド特有の観点

#### ① スケールアウト失敗

AutoScaling未起動

#### ② セキュリティ設定

Security Group / Firewall

#### ③ IAM権限不足

API失敗原因

---

## 7. 監視との連携

ログは事後確認。
リアルタイムは監視。

| 監視    | 役割         |
| ----- | ---------- |
| メトリクス | CPU等       |
| アラート  | しきい値超過     |
| ログ監視  | ERROR検知    |
| APM   | トランザクション解析 |

---

## 8. 恒久対策（再発防止）

単なる復旧では不十分。

| 分類   | 対策     |
| ---- | ------ |
| 設計不備 | 冗長化    |
| 容量不足 | スケール   |
| 設定不備 | 標準化    |
| 属人化  | 手順書整備  |
| 検知遅延 | アラート強化 |

---

## 9. インシデント報告フォーマット（実務）

```
■ 発生日
■ 検知方法
■ 影響範囲
■ 原因
■ 一時対処
■ 恒久対策
■ 再発防止策
```

---

## 10. 上級者向け分析手法

#### ● 相関分析

* リクエストID追跡
* 分散トレーシング

#### ● 3点同時確認

```
ログ
メトリクス
変更履歴
```

#### ● 再現環境検証

本番直修正は原則NG

---

## まとめ

ログ確認・トラブルシュートは

```
① 時系列整理
② 変更確認
③ エラー特定
④ 依存確認
⑤ リソース確認
⑥ 恒久対策
```

が王道です。

---
