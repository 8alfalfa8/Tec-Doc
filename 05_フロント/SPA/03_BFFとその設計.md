# ◆ BFF（Backend For Frontend）とその設計

以下では、**BFF（Backend For Frontend）とその設計**について、
**概念 → なぜ必要か → 全体アーキテクチャ → 設計原則 → API設計 → 認証認可 → 非機能 → 実装方式 → 成果物 → 失敗例**
の順で、**業務系（金融・公共レベル）で実際に設計書として通用する深さ**まで詳しくご説明します。

---

## 1. BFFとは何か（本質）

### 1.1 定義

**BFF（Backend For Frontend）とは、特定のフロントエンド専用に最適化されたバックエンド層**です。

* フロント（SPA / Mobile）ごとに用意
* UI都合のデータ構造・粒度に最適化
* 内部APIや外部サービスを隠蔽

👉 **BFFは「UIのための翻訳・統合層」**

---

## 2. なぜBFFが必要なのか

### 2.1 BFFなしで起きる問題

| 問題     | 内容             |
| ------ | -------------- |
| API乱立  | 画面ごとに複数API呼び出し |
| 過取得/不足 | UIに合わないレスポンス   |
| 認証分散   | フロントで認証ロジック    |
| セキュリティ | Token管理がJS側に露出 |

---

### 2.2 BFF導入による解決

| 観点     | 効果          |
| ------ | ----------- |
| UX     | API回数削減     |
| 開発     | フロント都合で進化可能 |
| 保守     | マイクロサービス非依存 |
| セキュリティ | 認証集約        |

---

## 3. BFFを含む全体アーキテクチャ

```
[ Browser (SPA) ]
        |
        | HTTPS
        v
[ CDN / WAF ]
        |
        v
[      BFF      ]
        |
        | 内部API
        v
[ Backend Services ]
        |
        v
[ DB / 外部API ]
```

#### BFFの責務

* データ集約
* フィールド整形
* 認証・認可
* UI特化API

---

## 4. BFF設計原則（最重要）

### 原則① フロント専用

* 他クライアントから再利用しない
* UI変更に追随可能

### 原則② ビジネスロジックは持たない

❌ 業務計算
⭕ UI制御・集約

### 原則③ 疎結合

* 下位API変更を吸収
* バージョン依存を隠す

### 原則④ セキュリティ境界

* 認証・認可を集中管理

---

## 5. BFF API設計

### 5.1 API粒度（画面単位）

#### 例：ダッシュボード画面

```
GET /bff/dashboard
```

```json
{
  "user": {...},
  "notifications": [...],
  "statistics": {...}
}
```

👉 **1画面 = 1 API が基本**

---

### 5.2 命名規則

* `/bff/{page}/{action}`
* REST厳守より **可読性優先**

---

### 5.3 レスポンス設計指針

* UIがそのまま描画できる形
* nullを極力出さない
* フラット構造

---

## 6. 認証・認可設計（BFFの中核）

### 6.1 認証の責務

* Cookie（HttpOnly）認証
* Token検証
* セッション管理

```
[ SPA ]
   |
   | Cookie
   v
[ BFF ] ← 認証
   |
   v
[ Backend ]
```

---

### 6.2 認可（権限制御）

* ロール／権限チェック
* API単位のアクセス制御
* UI表示可否情報を返却

---

## 7. エラーハンドリング設計

### エラー種別

| 種類   | 例   |
| ---- | --- |
| 認証   | 401 |
| 認可   | 403 |
| 業務   | 4xx |
| システム | 5xx |

👉 **フロントが扱いやすい形に正規化**

---

## 8. 非機能設計（業務レベル）

### 8.1 パフォーマンス

* 並列API呼び出し
* キャッシュ（短期）

### 8.2 可用性

* タイムアウト
* フォールバック

### 8.3 セキュリティ

* 入力検証
* レート制限
* 監査ログ

---

## 9. 実装方式

### 9.1 技術選択

| 技術               | 用途       |
| ---------------- | -------- |
| Node.js (NestJS) | SPA向け    |
| FastAPI          | Python系  |
| Spring Boot      | エンタープライズ |

---

### 9.2 処理フロー例

```
Request
 ↓
Auth Check
 ↓
Permission Check
 ↓
Call APIs (Parallel)
 ↓
Assemble Response
 ↓
Return
```

---

## 10. GraphQL型BFF（発展）

### 特徴

* フロント主導
* オーバーフェッチ防止
* 型安全

### 注意

* 認可設計が難しい
* 金融系ではREST型が主流

---

## 11. 成果物（設計書）

* BFFアーキテクチャ図
* BFF責務定義書
* API設計書
* 認証認可設計書
* エラーハンドリング設計書
* 非機能設計書

---

## 12. よくある失敗例

| 失敗         | 問題       |
| ---------- | -------- |
| BFFが業務ロジック | 責務違反     |
| BFF乱立      | 保守不能     |
| フロント直API   | セキュリティ事故 |
| 巨大BFF      | モノリス化    |

---

## 13. BFFが向いているケース / 不要なケース

| ケース        | 評価 |
| ---------- | -- |
| SPA + 複雑画面 | ◎  |
| マイクロサービス   | ◎  |
| 小規模CRUD    | △  |
| 単一画面       | 不要 |

---

### まとめ（設計者視点）

* BFFはUIのための層
* APIは画面単位
* 認証・認可の要
* 業務ロジックは持たせない
* 設計書で責務を固定する

---
---

# BFF／API設計書

> 本書は、SPA（Single Page Application）向けに設計される **BFF（Backend For Frontend）および下位API** の設計を定義する。
> 認証・認可設計、コンポーネント設計書、状態管理設計書と整合することを前提とする。

---

## 1. 目的・位置付け

### 1.1 目的

* SPAに最適化されたAPI仕様を定義する
* フロントエンドとバックエンドの責務境界を明確化する
* 認証・認可・エラーハンドリングを統一する

### 1.2 システム内位置付け

```
[ SPA ]
   |
   | HTTPS (Cookie)
   v
[ BFF ]
   |
   v
[ Backend API / Service ]
```

---

## 2. BFFの責務定義（重要）

### 2.1 BFFが担う責務

* フロントエンド専用API提供
* 認証・認可チェックの集約
* 複数APIのデータ集約・整形
* エラー形式の正規化

### 2.2 BFFが担わない責務（禁止）

* 業務計算ロジック
* DB直接操作（原則）
* 他クライアント向け共通API

---

## 3. API設計方針

### 3.1 基本方針

* **画面単位API** を原則とする
* REST原則より **UI可読性優先**
* SPAがそのまま描画できるレスポンス構造

### 3.2 命名規則

* BFF API: `/bff/{screen}/{action}`
* Backend API: `/api/{resource}`

---

## 4. 共通仕様

### 4.1 通信方式

| 項目    | 内容    |
| ----- | ----- |
| プロトコル | HTTPS |
| データ形式 | JSON  |
| 文字コード | UTF-8 |

---

### 4.2 認証・認可

* 認証方式：OIDC / JWT（HttpOnly Cookie）
* 認可方式：RBAC + ABAC

#### 認証情報取得API

```
GET /bff/me
```

レスポンス例：

```json
{
  "userId": "u001",
  "tenantId": "t001",
  "roles": ["manager"],
  "permissions": {
    "user.create": true,
    "user.delete": false
  }
}
```

---

### 4.3 エラーレスポンス共通形式

```json
{
  "code": "AUTH_403",
  "message": "権限がありません",
  "traceId": "xxxx"
}
```

| HTTP | 意味      |
| ---- | ------- |
| 401  | 未認証     |
| 403  | 認可エラー   |
| 404  | 存在隠蔽    |
| 500  | システムエラー |

---

## 5. BFF API一覧

| No  | 画面      | Method | URI            | 概要     |
| --- | ------- | ------ | -------------- | ------ |
| B01 | ログイン    | GET    | /bff/me        | 認証情報取得 |
| B02 | ダッシュボード | GET    | /bff/dashboard | 初期表示情報 |
| B03 | ユーザー一覧  | GET    | /bff/users     | 一覧取得   |
| B04 | ユーザー登録  | POST   | /bff/users     | 新規登録   |

---

## 6. API詳細設計（記入例）

### 6.1 ユーザー一覧取得

| 項目     | 内容         |
| ------ | ---------- |
| API ID | B03        |
| Method | GET        |
| URI    | /bff/users |
| 認証     | 必須         |
| 認可     | user.read  |

#### リクエスト（Query）

| 名称   | 型      | 必須 | 備考    |
| ---- | ------ | -- | ----- |
| page | number | ○  | ページ番号 |
| size | number | ○  | 件数    |

#### レスポンス

```json
{
  "items": [
    { "id": "u01", "name": "山田" }
  ],
  "page": 1,
  "total": 100
}
```

---

## 7. Backend API設計方針

### 7.1 設計原則

* リソース指向
* テナント境界必須

例：

```
GET /api/tenants/{tenantId}/users
```

---

## 8. 認可チェックフロー

```
Request
 ↓
認証確認
 ↓
テナント一致
 ↓
ロール判定
 ↓
Backend API呼び出し
```

---

## 9. 非機能設計

| 観点     | 方針              |
| ------ | --------------- |
| 性能     | 並列呼び出し          |
| 可用性    | Timeout / Retry |
| セキュリティ | RateLimit       |
| 監査     | 操作ログ            |

---

## 10. テスト観点

| 種別 | 内容      |
| -- | ------- |
| 正常 | 権限内アクセス |
| 異常 | 他テナント   |
| 境界 | 権限切替    |

---

## 11. レビュー観点

* 画面単位APIになっているか
* 認可チェックが全APIにあるか
* BFFに業務ロジックが混入していないか
* エラー形式が統一されているか

---

## 12. 関連ドキュメント

* コンポーネント設計書
* 状態管理設計書
* 認証・認可設計書
* マルチテナント認可設計書

---
---

この「BFF／API設計書」は、

* **SPA構成**
* **状態管理設計**
* **認証・認可（RBAC／マルチテナント）**
* **BFF責務分離**

と構成になっています。

---

## このBFF／API設計書の特徴（レビュー耐性高）

* **BFFとBackend APIの責務境界を明文化**
* 「なぜこのAPIはBFFにあるのか」を説明できる
* **SPAの画面・状態管理との対応関係**を明示
* **マルチテナント／認可チェックポイント**を設計レベルで固定
* OpenAPI化・試験設計・非機能まで含めた**提出可能成果物**

---

## よくある設計レビュー指摘への耐性

このテンプレートで以下に即答できます。

| レビュー指摘     | 本設計書での回答                  |
| ---------- | ------------------------- |
| なぜBFFが必要？  | 役割定義・集約責務・非集約APIの禁止を明記    |
| 認可はどこでやる？  | BFFでのテナント境界＋Backendでの二重防御 |
| 画面変更時の影響は？ | BFF集約単位で影響限定              |
| API増殖しない？  | API設計原則・命名規約で統制           |
| テストは？      | BFF単体／契約テスト／E2E観点を明記      |

---

